.file   "S_Handler.S"
        .text

        .global S_Handler
S_Handler:
        sub     sp, sp, #4
        stmfd   sp!, {r0-r12, lr}

        ldr        r12, =global_data
        ldr        r8, [r12]

        mrs     r2, cpsr
        bic     r2, r2, #0x80
        msr     cpsr, r2

        mrs     r2, spsr
        str     r2, [sp, #14*4]
        mov     r1, sp
        ldr     r0, [lr, #-4]
        bic     r0, r0, #0xff000000

        bl      C_SWI_Handler

        ldr     r2, [sp, #14*4]
        msr     spsr, r2
        add     sp, sp, #4
        ldmfd   sp!, {r1-r12, lr}
        add     sp, sp, #4
        movs    pc, lr
